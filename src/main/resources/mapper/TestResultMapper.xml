<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.student_testing.test.mapper.TestResultMapper">

    <insert id="insertResult">
        INSERT INTO test_results (
            test_id,
            student_username,
            score,
            percentile,
            rank_code,
            completed_at
        ) VALUES (
                     #{testId},
                     #{studentUsername},
                     #{score},
                     #{percentile},
                     #{rankCode},
                     CURRENT_TIMESTAMP
                 )
    </insert>

    <select id="findScoresByTestId" resultType="java.lang.Double">
        SELECT score FROM test_results WHERE test_id = #{testId}
    </select>

    <select id="findScoresByTestIdAndStudent" resultType="java.lang.Double">
        SELECT score FROM test_results
        WHERE test_id = #{testId} AND student_username = #{studentUsername}
    </select>

    <select id="findAll" resultType="org.example.student_testing.test.dto.TestResultDTO">
        SELECT test_id, student_username, score, percentile, rank_code, completed_at
        FROM test_results
    </select>

    <select id="filter" resultType="org.example.student_testing.test.dto.TestResultDTO">
        SELECT test_id, student_username, score, percentile, rank_code, completed_at
        FROM test_results
        WHERE 1=1
        <if test="testId != null">AND test_id = #{testId}</if>
        <if test="studentUsername != null">AND student_username = #{studentUsername}</if>
        <if test="minScore != null">AND score &gt;= #{minScore}</if>
        <if test="maxScore != null">AND score &lt;= #{maxScore}</if>
        <if test="rankCode != null">AND rank_code = #{rankCode}</if>
    </select>


    <!-- Kiểm tra đã nộp bài chưa -->
    <select id="hasSubmitted" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM test_results
        WHERE test_id = #{testId} AND student_username = #{username}
    </select>

    <!-- Lấy resultId của bài đã nộp -->
    <select id="findResultId" resultType="int">
        SELECT id
        FROM test_results
        WHERE test_id = #{testId} AND student_username = #{username}
            LIMIT 1
    </select>


    <select id="findById" resultType="org.example.student_testing.test.dto.TestResultDTO">
        SELECT r.id, r.test_id, r.student_username, r.score, r.percentile, r.rank_code, r.completed_at,
               t.test_name AS testName, t.test_type AS testType
        FROM test_results r
                 JOIN tests t ON r.test_id = t.test_id
        WHERE r.id = #{resultId}
    </select>



    <select id="findSubmissionsByTestId" resultType="org.example.student_testing.test.dto.SubmissionViewDTO">
        SELECT id AS resultId, student_username, score, rank_code, completed_at
        FROM test_results
        WHERE test_id = #{testId}
    </select>


    <select id="findStudentAnswer" resultType="string">
        SELECT student_answer
        FROM test_results
        WHERE question_id = #{questionId}
          AND student_username = #{username}
    </select>

    <select id="findCorrectAnswer" resultType="string">
        SELECT correct_answer
        FROM questions
        WHERE id = #{questionId}
    </select>


    <select id="countCompletedTestsByUsername" >
        select  count(id)
        from test_results
        where student_username = #{username}
    </select>


    <select id="calculateAverageScoreByUsername">
        select AVG(score)
        from test_results
        where student_username = #{username}
    </select>



    <select id="findAverageScoreByTopic"
            resultType="org.example.student_testing.test.dto.TopicScoreDTO">
        SELECT
            t.topic_name AS topicName,
            t.topic_id AS topicId,  AVG(CASE
                                            WHEN a.selected_option = q.correct_option THEN 100.0
                                            ELSE 0.0
            END) AS averageScore
        FROM
            student_answers a
                JOIN
            questions q ON a.question_id = q.question_id
                JOIN
            topics t ON q.topic_id = t.topic_id
        WHERE
            a.student_username = #{username}
        GROUP BY
            t.topic_name, t.topic_id
        ORDER BY
            averageScore ASC
    </select>



    <select id="findResultsByUsername" resultType="org.example.student_testing.test.dto.TestResultDTO">
        SELECT r.id AS resultId,
               r.test_id AS testId,
               r.student_username AS studentUsername,
               r.score,
               r.percentile,
               r.rank_code AS rankCode,
               r.completed_at AS completedAt,
               t.test_name AS testName,       t.test_type AS testType
        FROM test_results r
                 JOIN tests t ON r.test_id = t.test_id
        WHERE r.student_username = #{studentUsername}
        ORDER BY r.completed_at DESC
    </select>

    <select id="countCompletedAttempts" resultType="java.lang.Integer">
        select count(*)
        from test_results
        where test_id = #{testId}
        and student_username = #{username}
        and status = 'COMPLETED'
    </select>

</mapper>
