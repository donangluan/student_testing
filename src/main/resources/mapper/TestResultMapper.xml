<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.student_testing.test.mapper.TestResultMapper">

    <insert id="insertResult">
        INSERT INTO test_results (
            test_id,
            student_username,
            score,
            percentile,
            rank_code,
            completed_at
        ) VALUES (
                     #{testId},
                     #{studentUsername},
                     #{score},
                     #{percentile},
                     #{rankCode},
                     CURRENT_TIMESTAMP
                 )
    </insert>

    <select id="findScoresByTestId" resultType="java.lang.Double">
        SELECT score FROM test_results WHERE test_id = #{testId}
    </select>

    <select id="findScoresByTestIdAndStudent" resultType="java.lang.Double">
        SELECT score FROM test_results
        WHERE test_id = #{testId} AND student_username = #{studentUsername}
    </select>

    <select id="findAll" resultType="org.example.student_testing.test.dto.TestResultDTO">
        SELECT test_id, student_username, score, percentile, rank_code, completed_at
        FROM test_results
    </select>

    <select id="filter" resultType="org.example.student_testing.test.dto.TestResultDTO">
        SELECT test_id, student_username, score, percentile, rank_code, completed_at
        FROM test_results
        WHERE 1=1
        <if test="testId != null">AND test_id = #{testId}</if>
        <if test="studentUsername != null">AND student_username = #{studentUsername}</if>
        <if test="minScore != null">AND score &gt;= #{minScore}</if>
        <if test="maxScore != null">AND score &lt;= #{maxScore}</if>
        <if test="rankCode != null">AND rank_code = #{rankCode}</if>
    </select>


    <!-- Kiểm tra đã nộp bài chưa -->
    <select id="hasSubmitted" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM test_results
        WHERE test_id = #{testId} AND student_username = #{username}
    </select>

    <!-- Lấy resultId của bài đã nộp -->
    <select id="findResultId" resultType="int">
        SELECT id
        FROM test_results
        WHERE test_id = #{testId} AND student_username = #{username}
            LIMIT 1
    </select>


    <select id="findById" resultType="org.example.student_testing.test.dto.TestResultDTO">
        SELECT r.id, r.test_id, r.student_username, r.score, r.percentile, r.rank_code, r.completed_at,
               t.test_name AS testName, t.test_type AS testType
        FROM test_results r
                 JOIN tests t ON r.test_id = t.test_id
        WHERE r.id = #{resultId}
    </select>



    <select id="findSubmissionsByTestId" resultType="org.example.student_testing.test.dto.SubmissionViewDTO">
        SELECT id AS resultId, student_username, score, rank_code, completed_at
        FROM test_results
        WHERE test_id = #{testId}
    </select>



</mapper>
