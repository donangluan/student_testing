<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.student_testing.test.mapper.TestMapper">


    <insert id="insertTest" useGeneratedKeys="true" keyProperty="testId" parameterType="org.example.student_testing.test.dto.TestDTO">
        INSERT INTO tests(
            test_name,
            test_type,
            created_by,
            created_at,
            topic_id,
            duration_minutes,
            is_published,     start_time        )
        VALUES (
                   #{testName},
                   #{testType},
                   #{createdBy},
                   current_timestamp,
                   #{topicId},
                   #{durationMinutes},
                   #{isPublished},   #{startTime}      )
    </insert>



    <insert id="insertTestAssignment" parameterType="org.example.student_testing.test.dto.TestDTO">
        INSERT INTO test_assignments(test_id, student_username, assigned_at)
        VALUES (#{testId}, #{studentUsername}, #{assignedAt})
    </insert>





    <select id="findAllTests" resultType="org.example.student_testing.test.dto.TestDTO">
        SELECT test_id AS testId,
               test_name AS testName,
               test_type AS testType,
               created_by AS createdBy,
               created_at AS createdAt,
               topic_id AS topicId
        FROM tests
        ORDER BY created_at DESC
    </select>

    <select id="findTestById" resultType="org.example.student_testing.test.dto.TestDTO">
        SELECT t.test_id AS testId,
               t.test_name AS testName,
               t.test_type AS testType,
               t.created_by AS createdBy,
               t.created_at AS createdAt,
               t.topic_id AS topicId,
               t.duration_minutes AS durationMinutes,

               t.is_published AS isPublished,
               t.start_time AS startTime,
               t.end_time AS endTime,
               t.max_attempts AS maxAttempts,
               t.is_dynamic AS isDynamic,
               tp.topic_name AS topicName,
               c.course_name AS courseName
        FROM tests t
                 LEFT JOIN topics tp ON t.topic_id = tp.topic_id
                 LEFT JOIN courses c ON tp.course_id = c.course_id
        WHERE t.test_id = #{testId}
    </select>




    <select id="findTestsByType" resultType="org.example.student_testing.test.dto.TestDTO">
        SELECT t.test_id AS testId,
        t.test_name AS testName,
        t.test_type AS testType,
        t.created_by AS createdBy,
        t.created_at AS createdAt,
        t.topic_id AS topicId,
        tp.topic_name AS topicName
        FROM tests t
        LEFT JOIN topics tp ON t.topic_id = tp.topic_id
        WHERE t.test_type = #{type}
        ORDER BY t.created_at DESC
    </select>

    <select id="countAllTests" resultType="int">
        SELECT COUNT(*) FROM tests
    </select>


    <select id="findTestsAssignedToStudent" resultType="org.example.student_testing.test.dto.TestDTO">
        SELECT t.test_id AS testId,
        t.test_name AS testName,
        t.test_type AS testType,
        t.created_by AS createdBy,
        t.created_at AS createdAt,
        t.topic_id AS topicId,
        t.duration_minutes AS durationMinutes,
        t.is_published AS isPublished,
        t.start_time AS startTime,
        t.end_time AS endTime,
        t.is_dynamic AS isDynamic,
        t.max_attempts AS maxAttempts,

        tp.topic_name AS topicName <!-- Cột topicName được thêm vào -->
        FROM tests t
        JOIN test_assignments ta ON ta.test_id = t.test_id
        LEFT JOIN topics tp ON t.topic_id = tp.topic_id <!-- JOIN với bảng topics -->
        WHERE ta.student_username = #{studentUsername}
        ORDER BY t.created_at DESC
    </select>

    <select id="findResultsByStudent" resultType="org.example.student_testing.test.dto.TestResultDTO">
        SELECT * FROM test_results WHERE student_username = #{studentUsername}
    </select>


    <insert id="insertHistory">
        INSERT INTO ai_question_history (test_id, teacher_id, created_at)
        VALUES (#{testId}, #{teacherId}, #{createdAt})
    </insert>
    <select id="getAssignedStudents" resultType="String">
        SELECT DISTINCT student_username as studentUsername
        FROM test_assignments
        WHERE test_id = #{testId}
    </select>

    <select id="findQuestionsByTestId" resultType="org.example.student_testing.test.dto.QuestionDTO">
        SELECT
        tq.question_id AS questionId,

        CASE
        WHEN tq.source = 'ai' THEN ai.question_content
        ELSE q.content
        END AS content,

        CASE
        WHEN tq.source = 'ai' THEN ai.options ->> 'A'
        ELSE q.option_a
        END AS optionA,

        CASE
        WHEN tq.source = 'ai' THEN ai.options ->> 'B'
        ELSE q.option_b
        END AS optionB,

        CASE
        WHEN tq.source = 'ai' THEN ai.options ->> 'C'
        ELSE q.option_c
        END AS optionC,

        CASE
        WHEN tq.source = 'ai' THEN ai.options ->> 'D'
        ELSE q.option_d
        END AS optionD,

        CASE
        WHEN tq.source = 'ai' THEN ai.correct_answer
        ELSE q.correct_option
        END AS correctOption,

        tq.difficulty_id AS difficultyId,
        COALESCE(q.topic_id, NULL) AS topicId,
        tq.order_no AS orderNo,
        tq.source AS source

        FROM test_questions tq
        LEFT JOIN questions q ON tq.source = 'manual' AND tq.question_id = q.question_id
        LEFT JOIN ai_generated_questions ai ON tq.source = 'ai' AND tq.question_id = ai.id
        WHERE tq.test_id = #{testId}

        <if test="studentUsernameToView != null and studentUsernameToView != ''">
            AND tq.student_username = #{studentUsernameToView}
        </if>

        <if test="studentUsernameToView == null or studentUsernameToView == ''">
            AND tq.student_username IS NULL
        </if>

        ORDER BY tq.order_no
    </select>




        <select id="findTestNameById" resultType="String">
            SELECT test_name FROM tests WHERE test_id = #{testId}
        </select>



    <!-- Tìm conversationId -->
    <select id="findConversationId" resultType="int">
        SELECT conversation_id
        FROM test_conversations
        WHERE test_id = #{testId}
          AND student_username = #{studentUsername}
            LIMIT 1
    </select>

    <!-- Tạo mới conversationId -->
    <insert id="insertConversation">
        INSERT INTO test_conversations(test_id, student_username, conversation_id)
        VALUES(#{testId}, #{studentUsername}, #{conversationId})
    </insert>





    <insert id="insertCriteria" parameterType="org.example.student_testing.test.dto.TestCriteriaDTO">
        INSERT INTO test_criteria(test_id, topic_id, difficulty_id, question_count)
        VALUES (#{testId}, #{topicId}, #{difficultyId}, #{questionCount})
    </insert>

    <select id="getCriteriaByTestId" resultType="org.example.student_testing.test.dto.TestCriteriaDTO">
        SELECT tc.criteria_id AS criteriaId,
               tc.test_id AS testId,
               tc.topic_id AS topicId,
               tc.difficulty_id AS difficultyId,
               tc.question_count AS questionCount
        FROM test_criteria tc
        WHERE tc.test_id = #{testId}
    </select>

    <select id="findRandomQuestionsByCriteria" resultType="org.example.student_testing.test.entity.Question">
        SELECT  * FROM questions
        WHERE topic_id = #{param1} AND difficulty_id = #{param2}
        ORDER BY RANDOM()
            LIMIT #{param3}
    </select>




    <select id="countAssignedQuestionsForStudent" resultType="int">
        SELECT COUNT(*)
        FROM test_questions
        WHERE test_id = #{testId}
          AND student_username = #{studentUsername}
    </select>

</mapper>
