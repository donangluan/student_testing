<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Làm bài kiểm tra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="container mt-5">
<h2 class="mb-4">Làm bài kiểm tra</h2>


<div class="alert alert-warning text-center d-flex justify-content-between align-items-center">
    <div>
        <span class="fw-bold">Thời gian còn lại:</span>
        <span id="countdown" class="fw-bold text-danger fs-4">--:--</span>
    </div>
    <div id="statusMessage" class="text-success fw-bold"></div>
</div>

<form method="post" th:action="@{/student/submit}" id="submitForm">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="testId" th:value="${testId}" />
    <input type="hidden" name="remainingTimeSeconds" id="remainingTimeSecondsInput" value="" />
    <input type="hidden" id="testEndTimeHidden" th:value="${#temporals.format(testEndTime, 'yyyy-MM-dd HH:mm:ss')}"/>

    <div th:each="q, stat : ${questions}" class="mb-4 border p-3 rounded shadow-sm">
        <h5 th:text="${(stat.index + 1) + '. ' + q.content}">Câu hỏi</h5>

        <th:block th:with="selectedOption=${studentAnswers.get(q.questionId)}">
            <div class="form-check">
                <input class="form-check-input" type="radio" th:id="${'q_' + q.questionId + '_A'}"
                       th:name="${'q_' + q.questionId}" value="A"
                       th:checked="${selectedOption == 'A'}" required />
                <label class="form-check-label" th:for="${'q_' + q.questionId + '_A'}" th:text="${q.optionA}">A</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" th:id="${'q_' + q.questionId + '_B'}"
                       th:name="${'q_' + q.questionId}" value="B"
                       th:checked="${selectedOption == 'B'}" />
                <label class="form-check-label" th:for="${'q_' + q.questionId + '_B'}" th:text="${q.optionB}">B</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" th:id="${'q_' + q.questionId + '_C'}"
                       th:name="${'q_' + q.questionId}" value="C"
                       th:checked="${selectedOption == 'C'}" />
                <label class="form-check-label" th:for="${'q_' + q.questionId + '_C'}" th:text="${q.optionC}">C</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" th:id="${'q_' + q.questionId + '_D'}"
                       th:name="${'q_' + q.questionId}" value="D"
                       th:checked="${selectedOption == 'D'}" />
                <label class="form-check-label" th:for="${'q_' + q.questionId + '_D'}" th:text="${q.optionD}">D</label>
            </div>
        </th:block>
    </div>

    <div class="d-flex justify-content-between mt-5">
        <button type="button" id="pauseButton" class="btn btn-warning btn-lg">
            <i class="fas fa-pause"></i> Tạm dừng & Lưu bài
        </button>
        <button type="submit" class="btn btn-success btn-lg">
            <i class="fas fa-check"></i> Nộp bài
        </button>
    </div>
</form>

<form method="post" th:action="@{/student/pause}" id="pauseForm" style="display: none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="testId" th:value="${testId}" />
    <input type="hidden" name="remainingTimeSeconds" id="pauseRemainingTimeInput" value="0" />

</form>



<script th:src="@{/js/sockjs.min.js}"></script>
<script th:src="@{/js/stomp.min.js}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/


    const testId = /*[[${testId}]]*/ 0;
    let remaining = /*[[${initialTimeSeconds}]]*/ 1800;
    const testEndTimeString = /*[[${#temporals.format(testEndTime, 'yyyy-MM-dd HH:mm:ss')}]]*/ '';

    const currentUsername = /*[[${#authentication.name}]]*/ 'unknown_student';

    const countdownEl = document.getElementById("countdown");
    const submitForm = document.getElementById("submitForm");
    const remainingTimeSecondsInput = document.getElementById("remainingTimeSecondsInput");
    const pauseButton = document.getElementById("pauseButton");
    const pauseForm = document.getElementById("pauseForm");
    const statusMessageEl = document.getElementById("statusMessage");

    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    let timer;



    function startTimer() {


        let deadlineDate = null;
        if (testEndTimeString) {

            deadlineDate = new Date(testEndTimeString.replace(' ', 'T'));
        }


        if (remaining <= 0) {
            countdownEl.innerText = "00:00";
            alert("Thời gian làm bài đã hết hoặc bài kiểm tra đã quá hạn nộp tuyệt đối. Bài kiểm tra sẽ tự động được nộp.");
            remainingTimeSecondsInput.value = 0;
            submitForm.submit();
            return;
        }

        countdownEl.innerText = formatTime(remaining);

        timer = setInterval(() => {

            if (deadlineDate) {
                const now = new Date();
                if (now.getTime() >= deadlineDate.getTime()) {

                    clearInterval(timer);
                    countdownEl.innerText = "00:00";
                    alert("ĐÃ HẾT THỜI HẠN NỘP BÀI TUYỆT ĐỐI! Bài kiểm tra sẽ tự động được nộp.");
                    remainingTimeSecondsInput.value = 0;
                    submitForm.submit();
                    return;
                }
            }

            if (remaining <= 0) {
                clearInterval(timer);
                countdownEl.innerText = "00:00";
                alert("Đã hết giờ làm bài! Bài kiểm tra sẽ tự động được nộp.");
                remainingTimeSecondsInput.value = 0;
                submitForm.submit();
            } else {
                remaining--;
                countdownEl.innerText = formatTime(remaining);
                remainingTimeSecondsInput.value = remaining;
            }
            // -----------------------------------------------------------------

        }, 1000);
    }

    startTimer();


    pauseButton.addEventListener('click', function() {
        clearInterval(timer);
        pauseButton.disabled = true;
        statusMessageEl.innerText = "Đang lưu và tạm dừng...";


        const formData = new FormData(submitForm);


        pauseForm.querySelectorAll('input[name^="q_"]').forEach(input => input.remove());


        const pauseRemainingTimeInput = document.getElementById('pauseRemainingTimeInput');
        if (pauseRemainingTimeInput) {
            pauseRemainingTimeInput.value = remaining;
        }


        for (const [key, value] of formData.entries()) {
            if (key.startsWith('q_')) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                pauseForm.appendChild(input);
            }
        }


        pauseForm.submit();
    });


    submitForm.addEventListener('submit', function() {
        if (timer) {
            clearInterval(timer);
        }
    });




    var stompClient = null;

    function connectProctor(){
        var socket = new SockJS('/ws-proctor');

        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({},function(frame) {
            console.log('[Giám sát] đã kết nối hệ thống.');

            stompClient.subscribe('/topic/test/'+testId,function (message){
                var data = JSON.parse(message.body);
                if(data.sender === 'TEACHER'){

                    const targets = data.targetUsernames;
                    if (targets && targets.includes(currentUsername)) {
                        showTeacherWarning(data);
                    } else {
                        console.log(`[Cảnh báo GV] Đã bỏ qua, không phải dành cho ${currentUsername}. Targets: ${targets ? targets.join(', ') : 'None'}`);
                    }
                }else{

                }
            })

        },function(error){
            console.log('[Giám sát] lỗi kết nối' +error);
        })
    }

    function reportViolation(type, msg){

        if(stompClient && stompClient.connected){
            stompClient.send("/app/report-violation",{},JSON.stringify({
                'studentUsername': currentUsername,
                'testId': testId,
                'violationType': type,
                'message': msg,
                'time' : new Date().toLocaleTimeString('vi-VN')
            }));
            console.log(" Đã gửi báo cáo vi phạm: "+type);
        } else {
            console.log(" Lỗi: Kết nối giám sát chưa sẵn sàng, không thể gửi vi phạm: " + type);
        }
    }
    connectProctor();

    document.addEventListener("visibilitychange", function(){
        if(document.hidden){
            reportViolation("TAB_SWITCH","Học sinh đã chuyển tab hoặc ẩn trình duyệt.");
        }
    });

    function showTeacherWarning (data){
        const warningDiv = document.createElement('div');
        warningDiv.className= 'alert alert-danger alert-dismissible fade show fixed-top mx-auto mt-3 shadow-lg';
        warningDiv.style.maxWidth='600px';
        warningDiv.style.zIndex = '9999';
        warningDiv.style.left = '0';
        warningDiv.style.right = '0';
        warningDiv.style.textAlign = 'center';

        warningDiv.innerHTML= `
            <strong>Cảnh báo từ giáo viên </strong>
            <p class="mb-0 fs-5">${data.message}</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"
            aria-label="Close"
            ></button>
        `;
        document.body.prepend(warningDiv);
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(warningDiv);
            bsAlert.dispose();
        },10);

        console.log(`[Cảnh báo GV: ] ${data.message}`);
    }






</script>
</body>
</html>