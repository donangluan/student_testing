<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Làm bài kiểm tra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="container mt-5">
<h2 class="mb-4">Làm bài kiểm tra</h2>


<div class="alert alert-warning text-center d-flex justify-content-between align-items-center">
    <div>
        <span class="fw-bold">Thời gian còn lại:</span>
        <span id="countdown" class="fw-bold text-danger fs-4">--:--</span>
    </div>
    <div id="statusMessage" class="text-success fw-bold"></div>
</div>

<form method="post" th:action="@{/student/submit}" id="submitForm">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="testId" th:value="${testId}" />
    <input type="hidden" name="remainingTimeSeconds" id="remainingTimeSecondsInput" value="" />

    <div th:each="q, stat : ${questions}" class="mb-4 border p-3 rounded shadow-sm">
        <h5 th:text="${(stat.index + 1) + '. ' + q.content}">Câu hỏi</h5>

        <th:block th:with="selectedOption=${studentAnswers.get(q.questionId)}">
            <div class="form-check">
                <input class="form-check-input" type="radio" th:id="${'q_' + q.questionId + '_A'}"
                       th:name="${'q_' + q.questionId}" value="A"
                       th:checked="${selectedOption == 'A'}" required />
                <label class="form-check-label" th:for="${'q_' + q.questionId + '_A'}" th:text="${q.optionA}">A</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" th:id="${'q_' + q.questionId + '_B'}"
                       th:name="${'q_' + q.questionId}" value="B"
                       th:checked="${selectedOption == 'B'}" />
                <label class="form-check-label" th:for="${'q_' + q.questionId + '_B'}" th:text="${q.optionB}">B</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" th:id="${'q_' + q.questionId + '_C'}"
                       th:name="${'q_' + q.questionId}" value="C"
                       th:checked="${selectedOption == 'C'}" />
                <label class="form-check-label" th:for="${'q_' + q.questionId + '_C'}" th:text="${q.optionC}">C</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" th:id="${'q_' + q.questionId + '_D'}"
                       th:name="${'q_' + q.questionId}" value="D"
                       th:checked="${selectedOption == 'D'}" />
                <label class="form-check-label" th:for="${'q_' + q.questionId + '_D'}" th:text="${q.optionD}">D</label>
            </div>
        </th:block>
    </div>

    <div class="d-flex justify-content-between mt-5">
        <button type="button" id="pauseButton" class="btn btn-warning btn-lg">
            <i class="fas fa-pause"></i> Tạm dừng & Lưu bài
        </button>
        <button type="submit" class="btn btn-success btn-lg">
            <i class="fas fa-check"></i> Nộp bài
        </button>
    </div>
</form>

<form method="post" th:action="@{/student/pause}" id="pauseForm" style="display: none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <input type="hidden" name="testId" th:value="${testId}" />
    <input type="hidden" name="remainingTimeSeconds" id="pauseRemainingTimeInput" value="0" />

</form>

<script src="https://kit.fontawesome.com/your-font-awesome-kit.js" crossorigin="anonymous"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    const testId = /*[[${testId}]]*/ 0;
    let remaining = /*[[${initialTimeSeconds}]]*/ 1800;

    const countdownEl = document.getElementById("countdown");
    const submitForm = document.getElementById("submitForm");
    const remainingTimeSecondsInput = document.getElementById("remainingTimeSecondsInput");
    const pauseButton = document.getElementById("pauseButton");
    const pauseForm = document.getElementById("pauseForm");
    const statusMessageEl = document.getElementById("statusMessage");

    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    let timer;

    // -----------------------------------------------------
    // LOGIC BỘ ĐẾM NGƯỢC
    // -----------------------------------------------------
    function startTimer() {
        if (remaining <= 0) {
            countdownEl.innerText = "00:00";
            alert("Thời gian làm bài đã hết. Bài kiểm tra sẽ tự động được nộp.");
            remainingTimeSecondsInput.value = 0;
            submitForm.submit();
            return;
        }

        countdownEl.innerText = formatTime(remaining);

        timer = setInterval(() => {
            if (remaining <= 0) {
                clearInterval(timer);
                countdownEl.innerText = "00:00";
                alert("Đã hết giờ làm bài! Bài kiểm tra sẽ tự động được nộp.");
                remainingTimeSecondsInput.value = 0;
                submitForm.submit();
            } else {
                remaining--;
                countdownEl.innerText = formatTime(remaining);
                remainingTimeSecondsInput.value = remaining;
            }
        }, 1000);
    }

    startTimer();

    // -----------------------------------------------------
    // LOGIC TẠM DỪNG (SỬ DỤNG JAVASCRIPT THUẦN)
    // -----------------------------------------------------
    pauseButton.addEventListener('click', function() {
        clearInterval(timer);
        pauseButton.disabled = true;
        statusMessageEl.innerText = "Đang lưu và tạm dừng...";

        // 1. Lấy dữ liệu từ form chính
        const formData = new FormData(submitForm);

        // 2. Xóa tất cả các input cũ trong form phụ
        pauseForm.querySelectorAll('input[name^="q_"]').forEach(input => input.remove());

        // Lấy thông tin CSRF từ thẻ meta
        const pauseRemainingTimeInput = document.getElementById('pauseRemainingTimeInput');
        if (pauseRemainingTimeInput) {
            pauseRemainingTimeInput.value = remaining; // Biến JS 'remaining' chứa thời gian còn lại
        }

        // 2. CHỈ SAO CHÉP CÁC TRƯỜNG ĐÁP ÁN (q_...)
        for (const [key, value] of formData.entries()) {
            if (key.startsWith('q_')) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                pauseForm.appendChild(input);
            }
        }

        // 3. SUBMIT form phụ
        pauseForm.submit();
    });

    // -----------------------------------------------------
    // XỬ LÝ NỘP BÀI (Giữ nguyên)
    // -----------------------------------------------------
    submitForm.addEventListener('submit', function() {
        if (timer) {
            clearInterval(timer); // Đảm bảo dừng timer khi nộp bài
        }
    });

    /*]]>*/
</script>
</body>
</html>