<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Bài kiểm tra của tôi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="container mt-5">
<h2 class="mb-4">Bài kiểm tra được giao</h2>
<p class="text-muted">Xin chào, <strong th:text="${studentUsername}">username</strong></p>

<div class="text-end mt-4">
    <form th:action="@{/logout}" method="post" class="d-inline">
        <button type="submit" class="btn btn-sm btn-danger">Đăng xuất</button>
    </form>
</div>

<div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
    <i class="fas fa-check-circle"></i>
    <span th:text="${successMessage}">Thông báo thành công sẽ hiển thị ở đây.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
    <i class="fas fa-exclamation-triangle"></i>
    <span th:text="${errorMessage}">Thông báo lỗi sẽ hiển thị ở đây.</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<table class="table table-bordered table-hover">
    <thead class="table-light">
    <tr>
        <th>ID</th>
        <th>Tên bài kiểm tra</th>
        <th>Loại</th>
        <th>Bảo vệ</th>
        <th>Thao tác</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="test : ${tests}">
        <td th:text="${test.testId}">1</td>
        <td th:text="${test.testName}">Bài kiểm tra mẫu</td>
        <td th:text="${test.testType}">Unique</td>


        <td>
            <th:block th:if="${test.accessCode != null and !#strings.isEmpty(test.accessCode)}">
                <span class="badge bg-warning text-dark"
                      data-bs-toggle="tooltip" data-bs-placement="top" title="Bài thi yêu cầu Mã Truy Cập">
                    <i class="fas fa-lock"></i> Khóa
                </span>
            </th:block>
            <th:block th:unless="${test.accessCode != null and !#strings.isEmpty(test.accessCode)}">
                <span class="text-success"
                      data-bs-toggle="tooltip" data-bs-placement="top" title="Truy cập tự do">
                    <i class="fas fa-lock-open"></i> Mở
                </span>
            </th:block>
        </td>

        <td>
            <th:block th:with="submitted=${testResultMap.get(test.testId)}">
                <th:block th:with="expired=${testExpiredMap.get(test.testId)}">

                    <div th:if="${submitted}">

                        <th:block th:if="${expired}">
                            <span class="text-danger fw-bold me-2"><i class="fas fa-exclamation-triangle"></i> Đã thu hồi</span>
                            <a th:href="@{'/student/result?testId=' + ${test.testId}}" class="btn btn-sm btn-secondary">
                                <i class="fas fa-eye"></i> Xem kết quả (Hạn chế)
                            </a>
                        </th:block>

                        <th:block th:unless="${expired}">
                            <span class="text-success fw-bold me-2"><i class="fas fa-check-circle"></i> Đã hoàn thành</span>
                            <a th:href="@{'/student/result?testId=' + ${test.testId}}" class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i> Xem kết quả
                            </a>
                        </th:block>

                    </div>

                    <div th:unless="${submitted}">

                        <th:block th:if="${expired}">
                            <button class="btn btn-danger btn-sm" disabled>
                                <i class="fas fa-ban"></i> Đã hết hạn
                            </button>

                        </th:block>

                        <th:block th:unless="${expired}">
                            <a th:href="@{'/student/do/' + ${test.testId}}"
                               class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-play"></i> Làm bài (Cố định)
                            </a>

                            <a th:if="${#strings.equals(test.testType, 'Dynamic')}"
                               th:href="@{'/student/dynamic/do-test?testId=' + ${test.testId} +
                         '&studentUsername=' + ${studentUsername} +
                         '&testType=' + ${test.testType} +
                         ${test.topicId != null ? '&topicId=' + test.topicId : ''}
                         }"
                               class="btn btn-warning btn-sm me-2">
                                <i class="fas fa-cogs"></i> Làm bài động (Adaptive)
                            </a>
                        </th:block>
                    </div>

                </th:block>
            </th:block>
        </td>
    </tr>
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>

</body>
</html>