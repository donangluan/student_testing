<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>üìù T·∫°o ƒê·ªÅ Thi ƒê·ªông (Dynamic Test)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .student-list-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body class="container mt-5">

<h2 class="mb-4"> T·∫°o ƒê·ªÅ Thi ƒê·ªông (Dynamic Test)</h2>

<div th:if="${error}" class="alert alert-danger" role="alert">
    <span th:text="${error}"></span>
</div>
<div th:if="${success}" class="alert alert-success" role="alert">
    <span th:text="${success}"></span>
</div>

<form th:action="@{/teacher/tests/create-dynamic}" method="post" th:object="${test}" id="dynamicTestForm">

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">Th√¥ng tin B√†i ki·ªÉm tra</div>
        <div class="card-body">
            <div class="mb-3">
                <label for="testName" class="form-label">T√™n B√†i ki·ªÉm tra:</label>
                <input type="text" th:field="*{testName}" id="testName" class="form-control" required/>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            C·∫•u h√¨nh Ti√™u ch√≠ r√∫t c√¢u h·ªèi

            <button type="button" class="btn btn-sm btn-light" id="addCriteriaButton">
                <i class="fas fa-plus"></i> Th√™m Ti√™u ch√≠
            </button>
        </div>

        <div class="card-body">
            <table class="table table-bordered" id="criteriaTable">
                <tbody>
                <tr th:each="criteria, i : ${test.criteriaList}">
                    <td>
                        <select class="form-select" th:field="*{criteriaList[__${i.index}__].topicId}" required>
                            <option value="">Ch·ªçn Ch·ªß ƒë·ªÅ</option>
                            <option th:each="topic : ${allTopics}"
                                    th:value="${topic.topicId}"
                                    th:text="${topic.topicName}">
                            </option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select" th:field="*{criteriaList[__${i.index}__].difficultyId}" required>
                            <option value="">Ch·ªçn ƒê·ªô kh√≥</option>
                            <option th:each="diff : ${allDifficulties}"
                                    th:value="${diff.difficultyId}"
                                    th:text="${diff.description}">
                            </option>
                        </select>
                    </td>
                    <td>
                        <input type="number" th:field="*{criteriaList[__${i.index}__].questionCount}"
                               class="form-control" min="1" required/>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-criteria-button"
                                th:data-index="${i.index}"
                                th:disabled="${test.criteriaList.size() <= 1}">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            G√°n B√†i ki·ªÉm tra cho H·ªçc sinh
        </div>
        <div class="card-body">
            <div th:if="${allStudents == null or allStudents.isEmpty()}" class="alert alert-warning">
                Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o ƒë·ªÉ g√°n ƒë·ªÅ.
            </div>
            <div th:unless="${allStudents == null or allStudents.isEmpty()}">
                <label class="form-label d-block">Ch·ªçn H·ªçc sinh:</label>
                <div class="student-list-container">
                    <div class="form-check" th:each="student : ${allStudents}">
                        <input class="form-check-input student-checkbox" type="checkbox" name="studentUsername"
                               th:value="${student.username}" th:id="${'student_' + student.username}"
                               onchange="validateCheckboxes()">
                        <label class="form-check-label" th:for="${'student_' + student.username}">
                            <span th:text="${student.fullName}"></span> (<span th:text="${student.username}"></span>)
                        </label>
                    </div>
                </div>
                <div class="mt-2 text-danger" id="studentError" style="display:none;">Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h·ªçc sinh.</div>
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-success" id="submitButton">
        <i class="fas fa-check"></i> T·∫°o v√† G√°n ƒê·ªÅ Thi
    </button>
    <a th:href="@{/teacher/tests}" class="btn btn-secondary"><i class="fas fa-times"></i> H·ªßy</a>
</form>

<script>
    // H√†m n√†y ƒë·∫£m b·∫£o √≠t nh·∫•t m·ªôt checkbox ƒë∆∞·ª£c ch·ªçn khi submit
    function validateCheckboxes() {
        const checkboxes = document.querySelectorAll('input[name="studentUsername"]');
        let isChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        const submitButton = document.getElementById('submitButton');
        const studentError = document.getElementById('studentError');

        if (isChecked) {
            submitButton.removeAttribute('disabled');
            studentError.style.display = 'none';
            // B·ªè required cho c√°c checkbox ƒë·ªÉ browser kh√¥ng b√°o l·ªói
            checkboxes.forEach(cb => cb.removeAttribute('required'));
        } else {
            submitButton.setAttribute('disabled', 'disabled');
            studentError.style.display = 'block';
            // Th√™m required v√†o checkbox ƒë·∫ßu ti√™n ƒë·ªÉ k√≠ch ho·∫°t JS validation
            if (checkboxes.length > 0) {
                checkboxes[0].setAttribute('required', 'required');
            }
        }
        return isChecked;
    }

    // X·ª≠ l√Ω logic Th√™m/X√≥a Ti√™u ch√≠ b·∫±ng JavaScript
    document.getElementById('addCriteriaButton').addEventListener('click', function(event) {
        event.preventDefault(); // NgƒÉn ch·∫∑n form submit m·∫∑c ƒë·ªãnh

        // 1. Thay ƒë·ªïi action c·ªßa form th√†nh /add-criteria
        const form = document.getElementById('dynamicTestForm');
        form.action = '[[@{/teacher/tests/add-criteria}]]';
        form.method = 'POST'; // ƒê·∫£m b·∫£o method l√† POST

        // 2. Submit form
        form.submit();
    });

    // X·ª≠ l√Ω s·ª± ki·ªán X√≥a Ti√™u ch√≠
    document.querySelectorAll('.remove-criteria-button').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n form submit m·∫∑c ƒë·ªãnh

            const indexToRemove = this.getAttribute('data-index');

            // 1. T·∫°o input ·∫©n ƒë·ªÉ ch·ª©a index c·∫ßn x√≥a
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'removeIndex';
            hiddenInput.value = indexToRemove;

            const form = document.getElementById('dynamicTestForm');
            form.appendChild(hiddenInput); // Th√™m input ·∫©n v√†o form

            // 2. Thay ƒë·ªïi action c·ªßa form th√†nh /remove-criteria
            form.action = '[[@{/teacher/tests/remove-criteria}]]';
            form.method = 'POST';

            // 3. Submit form
            form.submit();
        });
    });


    // G·∫Øn s·ª± ki·ªán validate khi form ƒë∆∞·ª£c load l·∫ßn ƒë·∫ßu
    document.addEventListener('DOMContentLoaded', validateCheckboxes);

    // NgƒÉn ch·∫∑n submit form n·∫øu kh√¥ng c√≥ h·ªçc sinh n√†o ƒë∆∞·ª£c ch·ªçn (fallback)
    document.getElementById('dynamicTestForm').addEventListener('submit', function(event) {
        if (!validateCheckboxes()) {
            event.preventDefault();
        }
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>