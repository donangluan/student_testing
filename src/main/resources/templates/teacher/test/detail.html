<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi ti·∫øt ƒë·ªÅ ki·ªÉm tra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h2 class="mb-4">Chi ti·∫øt ƒë·ªÅ ki·ªÉm tra</h2>
<div id="live-alerts"
     style="position: fixed; top: 10px; right: 10px; z-index: 1050; width: 350px;">
</div>

<table class="table table-bordered table-striped table-hover">
    <thead class="table-light">
    <tr>
        <th>ID</th>
        <th>N·ªôi dung c√¢u h·ªèi</th>
        <th>ƒê·ªô kh√≥</th>
        <th>Ch·ªß ƒë·ªÅ</th>
        <th class="text-center">Ngu·ªìn</th>
        <th class="text-center">H√†nh ƒë·ªông</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="q : ${questions}">
        <td th:text="${q.questionId}">1</td>
        <td th:text="${q.content}">C√¢u h·ªèi m·∫´u</td>
        <td th:text="${q.difficultyId == 1 ? 'D·ªÖ' : (q.difficultyId == 2 ? 'Trung b√¨nh' : 'Kh√≥')}">Trung b√¨nh</td>
        <td th:text="${q.topicName != null ? q.topicName : 'Ch·ªß ƒë·ªÅ #' + q.topicId}">To√°n</td>
        <td class="text-center">
            <span th:class="${q.source == 'ai' ? 'badge bg-primary' : 'badge bg-secondary'}"
                  th:text="${q.source == 'ai' ? 'AI' : 'Th·ªß c√¥ng'}">Th·ªß c√¥ng</span>
        </td>
        <td class="text-center">
            <a th:href="@{/teacher/chatbot/question(conversationId=${conversationId}, questionId=${q.questionId})}"
               class="btn btn-sm btn-info">
                H·ªèi Chatbot
            </a>
        </td>
    </tr>
    </tbody>
</table>

<div class="card my-4 shadow">
    <div class="card-header bg-danger text-white"> G·ª≠i C·∫£nh b√°o Ch·ªß ƒë·ªông</div>
    <div class="card-body">

        <div class="mb-3">
            <label class="form-label fw-bold">Ch·ªçn H·ªçc sinh nh·∫≠n c·∫£nh b√°o (c√≥ th·ªÉ ch·ªçn nhi·ªÅu):</label>
            <div id="studentCheckboxes" class="border p-2 rounded bg-light">

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllStudents" onclick="toggleAllCheckboxes(this)">
                    <label class="form-check-label fw-bold text-primary" for="selectAllStudents">
                        G·ª≠i ƒë·∫øn T·∫§T C·∫¢ h·ªçc sinh ƒëang thi
                    </label>
                </div>
                <hr class="my-1">

                <div th:each="username : ${assignedStudents}" class="form-check">
                    <input class="form-check-input student-target" type="checkbox"
                           th:id="${'student_' + username}"
                           th:value="${username}"
                           name="targetUsername">
                    <label class="form-check-label" th:for="${'student_' + username}" th:text="${username}"></label>
                </div>

            </div>
        </div>

        <div class="input-group">
            <input type="text" id="warningMessageInput" class="form-control" placeholder="Nh·∫≠p n·ªôi dung c·∫£nh b√°o...">
            <button class="btn btn-danger" onclick="sendWarningMessage()">G·ª≠i C·∫£nh b√°o</button>
        </div>
    </div>
</div>

<script th:src="@{/js/sockjs.min.js}"></script>
<script th:src="@{/js/stomp.min.js}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var testId = /*[[${testId}]]*/ 0;
    var stompClient = null;

    function connectProctor() {
        var socket = new SockJS('/ws-proctor');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            console.log('üü¢ [GI√ÅO VI√äN] ƒêang gi√°m s√°t Test ID: ' + testId);


            stompClient.subscribe('/topic/test/' + testId, function (alert) {
                var alertData = JSON.parse(alert.body);
                showAlert(alertData);
            });
        }, function(error) {
            console.log('üî¥ L·ªói k·∫øt n·ªëi gi√°m s√°t: ' + error);
        });
    }

    function showAlert(data) {

        var alertBox = document.createElement("div");


        var alertClass = "alert-danger";
        var icon = "üö®";
        var title = "GIAN L·∫¨N!";

        if (data.violationType === 'WINDOW_BLUR') {
            alertClass = "alert-warning";
            icon = "‚ö†Ô∏è";
            title = "C·∫¢NH B√ÅO";
        }

        alertBox.className = `alert ${alertClass} alert-dismissible fade show shadow-lg border-2`;
        alertBox.style.marginBottom = "10px";
        alertBox.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${icon} ${title}</strong><br>
                    <strong>H·ªçc sinh:</strong> <span class="fs-5 text-uppercase fw-bold text-dark">${data.studentUsername}</span><br>
                    <strong>L·ªói:</strong> ${data.violationType}<br>
                    <small class="text-muted">Th·ªùi gian: ${data.time}</small><br>
                    <i>"${data.message}"</i>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;


        document.getElementById("live-alerts").prepend(alertBox);


        setTimeout(function() {

            alertBox.classList.remove('show');
            setTimeout(() => alertBox.remove(), 500);
        }, 10000);


        try {

        } catch(e) {}
    }


    connectProctor();
    /*]]>*/


    function sendWarningMessage(){
        var msgInput = document.getElementById("warningMessageInput");
        var message = msgInput.value.trim();

        var targetUsernames = Array.from(document.querySelectorAll('.student-target:checked'))
            .map(cb => cb.value);

        if(message && stompClient && stompClient.connected){
            var warningData = {
                'testId': testId,
                'message': message,
                'sender': 'TEACHER',
                'targetUsernames': targetUsernames
            };
            stompClient.send("/app/send-warning",{},JSON.stringify(warningData));
            console.log(`Tin nh·∫Øn c·∫£nh b√°o ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn: ${targetUsernames.join(', ')}`);
            document.getElementById("warningMessageInput").value = '';
            msgInput='';
        }else{
            console.log("L·ªói: Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi");
        }
    }

    function toggleAllCheckboxes(source) {
        let checkboxes = document.querySelectorAll('.student-target');
        for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
    }

</script>


</body>
</html>
