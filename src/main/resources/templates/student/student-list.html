<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
<head>
    <meta charset="UTF-8">
    <title>Title</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
</head>
<body class="bg-light">



<div th:insert="fragments/navbar :: navbar"></div>
<div class="text-end mb-3">
    <span sec:authentication="name" class="me-2"></span>
    <span sec:authorize="hasRole('ADMIN')" class="badge bg-danger">ADMIN</span>
    <span sec:authorize="hasRole('TEACHER')" class="badge bg-primary">TEACHER</span>
    <span sec:authorize="hasRole('STUDENT')" class="badge bg-success">STUDENT</span>
    <form th:action="@{/logout}" method="post" class="d-inline">
        <button type="submit" class="btn btn-sm btn-danger">Đăng xuất</button>
    </form>
</div>


<div class="container mt-4">
    <h2 class="text-center mb-4">Student List</h2>

    <div class="row g-2 align-items-center mb-3">

        <div class="col-md-2" sec:authorize="hasAnyRole('ADMIN')">
            <a th:href="@{/student/add}" class="btn btn-success w-100">Add Student</a>
        </div>


        <div class="col-md-5">
            <form th:action="@{/student/search}" method="get" class="d-flex"  sec:authorize="hasAnyRole('ADMIN','TEACHER')">
                <input type="text" class="form-control me-2" name="keyword"
                       placeholder="Search by Student ID, Name, Email"
                       th:value="${keyword}">
                <input type="hidden" name="status" th:value="${status}">
                <input type="hidden" name="courseName" th:value="${courseName}">
                <button type="submit" class="btn btn-outline-primary">Search</button>
            </form>
        </div>


        <div class="col-md-5">
            <form th:action="@{/student/filter}" method="get" id="filterForm" class="row g-2"  sec:authorize="hasAnyRole('ADMIN','TEACHER')">
                <input type="hidden" name="keyword" th:value="${keyword}">
                <input type="hidden" name="page" th:value="${currentPage}">
                <input type="hidden" name="size" th:value="${size}">
                <div class="col-md-6">
                    <select name="status" id="statusSelect" class="form-select">
                        <option value="">-- Select status --</option>
                        <option value="active" th:selected="${status == 'active'}">Active</option>
                        <option value="inactive" th:selected="${status == 'inactive'}">Inactive</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <select name="courseName" id="courseSelect" class="form-select">
                        <option value="">-- All Courses --</option>
                        <th:block th:each="c : ${courses}">
                            <option th:value="${c.courseName}" th:text="${c.courseName}"
                                    th:selected="${courseName == c.courseName}"></option>
                        </th:block>
                    </select>
                </div>
            </form>
        </div>
    </div>


    <form th:action="@{/student/import}" method="post" enctype="multipart/form-data"  class="mb-3" sec:authorize="hasAnyRole('ADMIN')">
        <div class="input-group">
            <input type="file" name="file" accept=".xlsx" class="form-control"/>
            <button type="submit" class="btn btn-outline-success">Import Excel</button>
        </div>
    </form>


    <a th:href="@{/student/export}" class="btn btn-outline-secondary mb-3"  sec:authorize="hasAnyRole('ADMIN','TEACHER')" >Export Excel</a>


    <table class="table table-bordered table-hover">
        <thead class="table-dark">
        <tr>
            <th>Student ID</th>
            <th>Full Name</th>
            <th>Date of Birth</th>
            <th>Gender</th>
            <th>Email</th>
            <th>Course</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="s : ${dto}">
            <td th:text="${s.studentId}"></td>
            <td th:text="${s.fullName}"></td>
            <td th:text="${#dates.format(s.dob, 'dd/MM/yyyy')}"></td>
            <td th:text="${s.gender ? 'Male' : 'Female'}"></td>
            <td th:text="${s.email}"></td>
            <td th:text="${s.courseName}"></td>
            <td th:text="${s.status}"></td>
            <td>

                <a th:href="@{/student/edit/{studentId}(studentId=${s.studentId})}" class="btn btn-sm btn-warning" sec:authorize="hasAnyRole('ADMIN')" >Edit</a>
                <a th:href="@{/student/delete/{studentId}(studentId=${s.studentId})}" class="btn btn-sm btn-danger" sec:authorize="hasAnyRole('ADMIN')"
                   onclick="return confirm('Are you sure you want to delete this student?')">Delete</a>
            </td>
        </tr>
        </tbody>
        <tr th:if="${dto == null or dto.isEmpty()}">
            <td colspan="8" class="text-center text-muted">Không tìm thấy học sinh nào phù hợp.</td>
        </tr>


    </table>


    <nav th:if="${dto !=null and !dto.isEmpty()}">
        <ul class="pagination justify-content-center">


            <th:block th:switch="${currentMode}">
                <th:block th:case="'search'">
                    <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/student/search(keyword=${keyword}, status=${status}, courseName=${courseName}, page=${currentPage - 1}, size=${size})}">
                            Previous
                        </a>
                    </li>
                </th:block>
                <th:block th:case="'filter'">
                    <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/student/filter(status=${status}, courseName=${courseName}, keyword=${keyword}, page=${currentPage - 1}, size=${size})}">
                            Previous
                        </a>
                    </li>
                </th:block>
                <th:block th:case="'list'">
                    <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/student/list(page=${currentPage - 1}, size=${size})}">
                            Previous
                        </a>
                    </li>
                </th:block>
            </th:block>


            <th:block th:each="i : ${#numbers.sequence(1, totalPages)}">
                <th:block th:switch="${currentMode}">
                    <th:block th:case="'search'">
                        <li class="page-item" th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link"
                               th:href="@{/student/search(keyword=${keyword}, status=${status}, courseName=${courseName}, page=${i}, size=${size})}"
                               th:text="${i}"></a>
                        </li>
                    </th:block>
                    <th:block th:case="'filter'">
                        <li class="page-item" th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link"
                               th:href="@{/student/filter(status=${status}, courseName=${courseName}, keyword=${keyword}, page=${i}, size=${size})}"
                               th:text="${i}"></a>
                        </li>
                    </th:block>
                    <th:block th:case="'list'">
                        <li class="page-item" th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link"
                               th:href="@{/student/list(page=${i}, size=${size})}"
                               th:text="${i}"></a>
                        </li>
                    </th:block>
                </th:block>
            </th:block>


            <th:block th:switch="${currentMode}">
                <th:block th:case="'search'">
                    <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/student/search(keyword=${keyword}, status=${status}, courseName=${courseName}, page=${currentPage + 1}, size=${size})}">
                            Next
                        </a>
                    </li>
                </th:block>
                <th:block th:case="'filter'">
                    <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/student/filter(status=${status}, courseName=${courseName}, keyword=${keyword}, page=${currentPage + 1}, size=${size})}">
                            Next
                        </a>
                    </li>
                </th:block>
                <th:block th:case="'list'">
                    <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/student/list(page=${currentPage + 1}, size=${size})}">
                            Next
                        </a>
                    </li>
                </th:block>
            </th:block>

        </ul>
    </nav>

</div>
<div id="successAlert" th:if="${successMessage}" class="alert alert-success text-center">
    <span th:text="${successMessage}"></span>
</div>

<div id="errorAlert" th:if="${errorMessage}" class="alert alert-danger text-center">
    <span th:text="${errorMessage}"></span>
</div>




<script>
    const form = document.getElementById('filterForm');
    const statusSelect = document.getElementById('statusSelect');
    const courseSelect = document.getElementById('courseSelect');

    statusSelect.addEventListener('change', () => form.submit());
    courseSelect.addEventListener('change', () => form.submit());
</script>

<script>

    setTimeout(() => {
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        [successAlert, errorAlert].forEach(alert => {
            if (alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }
        });
    }, 3000);
</script>



<div th:insert="fragments/footer :: footer"></div>
</body>


</html>